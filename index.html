<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indoor AR Navigation</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- QR Code Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>Indoor Navigation</h1>
        <p class="subtitle" id="subtitle">Select Block</p>

        <!-- Block Selection -->
        <div id="blockSelection" style="text-align: center; margin-bottom: 20px;">
            <button class="btn" onclick="selectBlock('C')" style="background-color: #2e7d32; margin: 5px;">Block
                C</button>
            <button class="btn" onclick="selectBlock('E')" style="background-color: #1976d2; margin: 5px;">Block
                E</button>
        </div>

        <div id="navControls" style="display: none;">
            <p id="activeBlockLabel" style="text-align: center; color: #888; margin-bottom: 10px;"></p>
            <button onclick="resetBlock()"
                style="background:none; border:none; color: #666; cursor:pointer; width:100%">‚Üê Change Block</button>

            <!-- QR Scan Section (Only for C for now, or unified if generic) -->
            <div class="form-group" style="text-align: center;">
                <button id="scanQrBtn" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">üì∑ Scan QR
                    Code</button>
                <p id="scannedRoom" style="font-weight: bold; min-height: 20px;"></p>
                <div id="qr-reader" style="width: 100%; display: none; margin: 10px auto;"></div>
            </div>

            <div class="form-group">
                <label for="start">Start Location:</label>
                <select id="start" class="select-box">
                    <option value="">-- Load Map First --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="destination">Destination:</label>
                <select id="destination" class="select-box">
                    <option value="">-- Select Destination --</option>
                </select>
            </div>

            <button id="startBtn" class="btn">Start Navigation</button>
            <p id="error" class="error"></p>
        </div>
    </div>

    <script src="js/mapService.js"></script>
    <script src="js/mapServiceE.js"></script>
    <script>
        let currentBlock = null;

        // Block Selection
        async function selectBlock(block) {
            currentBlock = block;
            document.getElementById('blockSelection').style.display = 'none';
            document.getElementById('navControls').style.display = 'block';
            document.getElementById('subtitle').textContent = `Block ${block}`;
            document.getElementById('activeBlockLabel').textContent = `Navigating Block ${block}`;

            if (block === 'C') {
                await MapService.loadMap();
                populateDropdowns(MapService.graph, 'C');
            } else if (block === 'E') {
                await MapServiceE.loadMap();
                populateDropdowns(MapServiceE.mapData.rooms, 'E');
            }
        }

        function resetBlock() {
            document.getElementById('blockSelection').style.display = 'block';
            document.getElementById('navControls').style.display = 'none';
            document.getElementById('subtitle').textContent = "Select Block";
            currentBlock = null;
        }

        function populateDropdowns(data, block) {
            const startSelect = document.getElementById('start');
            const destSelect = document.getElementById('destination');
            let rooms = [];

            if (block === 'C') {
                // Block C Data Structure (Graph Nodes)
                rooms = Object.keys(data).filter(key => {
                    const type = data[key].type;
                    return type === 'room' || type === 'staircase';
                }).map(key => key.toUpperCase()).sort();
            } else {
                // Block E Data Structure (Array of Objects)
                rooms = data.map(r => r.id).sort();
            }

            // Clear existing options
            startSelect.innerHTML = '<option value="">-- Select Start --</option>';
            destSelect.innerHTML = '<option value="">-- Select Destination --</option>';

            rooms.forEach(room => {
                const opt1 = document.createElement('option');
                opt1.value = room;
                opt1.textContent = room;
                startSelect.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = room;
                opt2.textContent = room;
                destSelect.appendChild(opt2);
            });
        }

        // --- QR Code Logic ---
        let html5QrCode;
        document.getElementById('scanQrBtn').addEventListener('click', function () {
            const qrReader = document.getElementById('qr-reader');
            const btn = this;
            const scannedRoomEl = document.getElementById('scannedRoom');
            const startSelect = document.getElementById('start');

            if (qrReader.style.display === 'none') {
                // Start scanning
                qrReader.style.display = 'block';
                btn.textContent = '‚ùå Stop Scanning';
                btn.style.background = '#ff4444'; // Red
                scannedRoomEl.textContent = 'Point camera at QR code...';
                scannedRoomEl.style.color = '#666';

                html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                    console.log('QR Scanned:', decodedText);
                    const options = Array.from(startSelect.options).map(o => o.value);
                    let match = options.find(o => o === decodedText || o === decodedText.toUpperCase() || o === decodedText.replace('-', '').toUpperCase());

                    if (match) {
                        startSelect.value = match;
                        scannedRoomEl.textContent = `‚úì Detected: ${match}`;
                        scannedRoomEl.style.color = 'green';
                        html5QrCode.stop().then(() => {
                            qrReader.style.display = 'none';
                            btn.textContent = 'üì∑ Scan QR Code';
                            btn.style.background = ''; // Reset
                        });
                    } else {
                        scannedRoomEl.textContent = `‚ö† Unknown QR for Block ${currentBlock}: ${decodedText}`;
                        scannedRoomEl.style.color = 'red';
                    }
                }, (errorMessage) => {
                    // Ignore scan errors
                }).catch(err => {
                    console.error("Camera Error", err);
                    alert("Camera not found or permission denied.");
                });

            } else {
                if (html5QrCode) {
                    html5QrCode.stop().then(() => {
                        qrReader.style.display = 'none';
                        btn.textContent = 'üì∑ Scan QR Code';
                        btn.style.background = '';
                    });
                }
            }
        });

        // --- Navigation Logic ---
        document.getElementById('startBtn').addEventListener('click', function () {
            const startValue = document.getElementById('start').value;
            const destValue = document.getElementById('destination').value;
            const errorEl = document.getElementById('error');

            if (!startValue || !destValue) {
                errorEl.textContent = 'Please select both start and destination';
                return;
            }

            let routeObject = {};

            if (currentBlock === 'C') {
                const startKey = startValue.toLowerCase();
                const destKey = destValue.toLowerCase();
                // 1. Calculate Path (BFS)
                const path = MapService.bfs(startKey, destKey);
                if (!path) {
                    errorEl.textContent = 'No path found.';
                    return;
                }
                const points = MapService.generatePathCoordinates(path);
                const instructions = MapService.generateDirections(path);

                routeObject = {
                    path: path,
                    points: points,
                    instructions: instructions,
                    distance: path.length * 5,
                    startNode: startKey,
                    block: 'C'
                };
            } else {
                // Block E Logic
                // Note: Block E is simple 2D mainly, provided logic only returns instructions.
                // We don't have a 3D point generator for E yet. AR might not work.
                const instructions = MapServiceE.navigate(startValue, destValue);

                routeObject = {
                    path: [startValue, destValue], // Dummy path structure
                    points: [], // No AR points for E
                    instructions: instructions,
                    distance: 0, // Not calc
                    startNode: startValue,
                    block: 'E'
                };
            }

            localStorage.setItem('currentRoute', JSON.stringify(routeObject));
            localStorage.setItem('destination', destValue);
            localStorage.setItem('step', 0);

            // Redirect
            window.location.href = 'navigation.html';
        });

        // init removed, waiting for user selection
    </script>
</body>

</html>