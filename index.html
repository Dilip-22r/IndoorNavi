<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indoor AR Navigation</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="container">
        <h1>Indoor AR Navigation</h1>
        <p class="subtitle">Block-C, Floor 2</p>

        <div class="form-group">
            <label for="start">Start Room:</label>
            <select id="start" class="select-box">
                <option value="C201">C-201 (Fixed Start)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="destination">Destination:</label>
            <select id="destination" class="select-box">
                <option value="">-- Select Destination --</option>
                <option value="C203">C-203</option>
                <option value="C205">C-205</option>
                <option value="C214">C-214</option>
            </select>
        </div>

        <button id="startBtn" class="btn">Start Navigation</button>
        <p id="error" class="error"></p>
    </div>

    <script src="js/mapService.js"></script>
    <script>
        // Initialize Map
        async function init() {
            await MapService.loadMap();
            populateDropdowns();
        }

        function populateDropdowns() {
            const startSelect = document.getElementById('start');
            const destSelect = document.getElementById('destination');

            if (!MapService.graph) return;

            // extracting all rooms and staircases, sorting them
            const rooms = Object.keys(MapService.graph)
                .filter(key => {
                    const type = MapService.graph[key].type;
                    return type === 'room' || type === 'staircase';
                })
                .map(key => key.toUpperCase())
                .sort();

            // Clear existing options
            startSelect.innerHTML = '<option value="">Select Start...</option>';
            destSelect.innerHTML = '<option value="">Select Destination...</option>';

            rooms.forEach(room => {
                const opt1 = document.createElement('option');
                opt1.value = room;
                opt1.textContent = room;
                startSelect.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = room;
                opt2.textContent = room;
                destSelect.appendChild(opt2);
            });

            // Set Default Start as C201 if exists
            if (rooms.includes('C201')) {
                startSelect.value = 'C201';
            }
        }

        document.getElementById('startBtn').addEventListener('click', function () {
            const start = document.getElementById('start').value.toLowerCase();
            const destination = document.getElementById('destination').value.toLowerCase();
            const errorEl = document.getElementById('error');

            if (!start || !destination) {
                errorEl.textContent = 'Please select both start and destination';
                return;
            }

            // 1. Calculate Path (BFS)
            const path = MapService.bfs(start, destination);
            if (!path) {
                errorEl.textContent = 'No path found between these locations.';
                return;
            }

            // 2. Generate 3D Coordinates (for AR)
            const points = MapService.generatePathCoordinates(path);

            // 3. Generate Text Instructions (for 2D Nav)
            const instructions = MapService.generateDirections(path);

            // 4. Save to LocalStorage
            const routeObject = {
                path: path,
                points: points,
                instructions: instructions,
                distance: path.length * 5 // Approx distance
            };

            localStorage.setItem('currentRoute', JSON.stringify(routeObject));
            localStorage.setItem('destination', destination.toUpperCase());
            localStorage.setItem('step', 0);
            localStorage.setItem('routeKey', "custom"); // flag for AR

            window.location.href = 'navigation.html';
        });

        // Run Init
        init();
    </script>
</body>

</html>